package com.sourceforgery.swedbank

import com.google.gson.Gson
import okhttp3.FormBody
import okhttp3.HttpUrl
import okhttp3.OkHttpClient
import okhttp3.Request
import okhttp3.logging.HttpLoggingInterceptor
import java.io.IOException
import java.util.Collections

interface ECardAPI {
    fun closeCard(creditCardNumber: String)
    fun getActiveECards(start: Int): List<ActiveECard>
    fun createCard(transactionLimit: Int, cumulativeLimit: Int, validForMonths: Int): CPN
    fun getPastTransactions(start: Int): List<PastTransaction>
    fun serializeState(): String

    companion object {
        internal val NONSENSE_BUT_VALID_URL = HttpUrl.parse("https://example.com/") ?: throw RuntimeException("Newspeak? Jvm is broken")
        internal fun queryToHashMap(httpUrl: HttpUrl): MutableMap<String, String> {
            val result = LinkedHashMap<String, String>()
            for (i in 0..httpUrl.querySize() - 1) {
                result.put(httpUrl.queryParameterName(i), httpUrl.queryParameterValue(i))
            }
            return result
        }

        internal fun queryToHashMap(encodedQuery: String): MutableMap<String, String> {
            return queryToHashMap(
                    NONSENSE_BUT_VALID_URL.newBuilder()
                            .encodedQuery(encodedQuery)
                            .build()
            )
        }

        fun afterLogin(okhttpClient: OkHttpClient,
                       cookieMonster: CookieMonster,
                       loggingInterceptor: HttpLoggingInterceptor,
                       thinOpenerUrl: HttpUrl): ECardAPIImpl {
            val map = queryToHashMap(thinOpenerUrl)
            map.put("Request", "GetActiveCards")
            val webServletUrl = thinOpenerUrl.newBuilder().encodedPath("/servlet/WebServlet").query(null).build()
            val api = ECardAPIImpl(okhttpClient, cookieMonster, loggingInterceptor, webServletUrl, null)
            val result = api.executeWebServlet(map)
            val realCards = Collections.unmodifiableList(RealCard.from(result))
            api.realCard = realCards[0]
            api.listProfile()
            return api
        }


        fun unpack(serializedState: String): ECardAPIImpl {
            val loggingInterceptor: HttpLoggingInterceptor = HttpLoggingInterceptor({ logger.log(it) })
            val cookieMonster = CookieMonster()
            val deserializedState = Gson().fromJson(serializedState, SerializedState::class.java)
            cookieMonster.deserializeAllCookies(deserializedState.cookies)
            val okhttpClient = OkHttpClient.Builder().cookieJar(cookieMonster)
                    .addNetworkInterceptor(loggingInterceptor)
                    .addNetworkInterceptor(
                            { chain ->
                                chain.proceed(chain.request()
                                        .newBuilder()
                                        .header("User-Agent", "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.104 Safari/537.36")
                                        .build())
                            }).build()
            return ECardAPIImpl(okhttpClient, cookieMonster, loggingInterceptor, HttpUrl.parse(deserializedState.webServletUrl)!!, deserializedState.realCard)
        }
    }

}

internal class SerializedState(val cookies: Set<CookieMonster.CookieId>, webServletUrl: HttpUrl, val realCard: RealCard) {
    val webServletUrl = webServletUrl.toString()
}

class ECardAPIMock : ECardAPI {
    override fun closeCard(creditCardNumber: String) {
        System.err.println("Card closed")
    }

    override fun getActiveECards(start: Int): List<ActiveECard> {
        System.err.println("Faking getActiveECards")
        return ActiveECard.from(ECardAPI.queryToHashMap("Action=ActiveAccounts&End=9&RecordCount=10&Start=0&SessionId=0000000000000000000000000000000000000000&Total=10&MerchantId1=00000000000000000erchantName1=-&AVV1=592&CPNType1=MA&Currency1=752&Expiry1=09%2F17&IssueDate1=12%2F07%2F17&NumUsage1=0&PAN1=0000000000000000&StartDate1=07%2F17&ValidFrom1=12%2F07%2F17&ValidTo1=30%2F09%2F17&TransactionLimit1=kr3.500%2C00&UTransactionLimit1=3500%2C00&CumulativeLimit1=kr3.500%2C00&UCumulativeLimit1=3500%2C00&AuthAmount1=kr2.967%2C81&OpenToBuy1=kr532%2C19&UOpenToBuy1=532%2C19&MerchantId2=00000000000000000erchantName2=-&AVV2=740&CPNType2=MA&Currency2=752&Expiry2=09%2F17&IssueDate2=12%2F07%2F17&NumUsage2=0&PAN2=0000000000000000&StartDate2=07%2F17&ValidFrom2=12%2F07%2F17&ValidTo2=30%2F09%2F17&TransactionLimit2=kr3.500%2C00&UTransactionLimit2=3500%2C00&CumulativeLimit2=kr3.500%2C00&UCumulativeLimit2=3500%2C00&AuthAmount2=kr0%2C00&OpenToBuy2=kr3.500%2C00&UOpenToBuy2=3500%2C00&MerchantId3=00000000000000000MerchantName3=-&AVV3=152&CPNType3=MA&Currency3=752&Expiry3=09%2F17&IssueDate3=12%2F07%2F17&NumUsage3=0&PAN3=0000000000000000&StartDate3=07%2F17&ValidFrom3=12%2F07%2F17&ValidTo3=30%2F09%2F17&TransactionLimit3=kr3.500%2C00&UTransactionLimit3=3500%2C00&CumulativeLimit3=kr3.500%2C00&UCumulativeLimit3=3500%2C00&AuthAmount3=kr0%2C00&OpenToBuy3=kr3.500%2C00&UOpenToBuy3=3500%2C00&MerchantId4=00000000000000000erchantName4=-&AVV4=979&CPNType4=MA&Currency4=752&Expiry4=06%2F18&IssueDate4=28%2F06%2F17&NumUsage4=0&PAN4=0000000000000000&StartDate4=06%2F17&ValidFrom4=28%2F06%2F17&ValidTo4=30%2F06%2F18&TransactionLimit4=kr1.000%2C00&UTransactionLimit4=1000%2C00&CumulativeLimit4=kr1.000%2C00&UCumulativeLimit4=1000%2C00&AuthAmount4=kr732%2C14&OpenToBuy4=kr264%2C33&UOpenToBuy4=264%2C33&MerchantId5=00000000000000000erchantName5=-&AVV5=195&CPNType5=MA&Currency5=752&Expiry5=09%2F17&IssueDate5=05%2F03%2F17&NumUsage5=0&PAN5=0000000000000000&StartDate5=03%2F17&ValidFrom5=05%2F03%2F17&ValidTo5=30%2F09%2F17&TransactionLimit5=kr500%2C00&UTransactionLimit5=500%2C00&CumulativeLimit5=kr500%2C00&UCumulativeLimit5=500%2C00&AuthAmount5=kr190%2C75&OpenToBuy5=kr306%2C19&UOpenToBuy5=306%2C19&MerchantId6=00000000000000000erchantName6=-&AVV6=695&CPNType6=MA&Currency6=752&Expiry6=12%2F17&IssueDate6=03%2F12%2F16&NumUsage6=0&PAN6=0000000000000000&StartDate6=12%2F16&ValidFrom6=03%2F12%2F16&ValidTo6=31%2F12%2F17&TransactionLimit6=kr1.000%2C00&UTransactionLimit6=1000%2C00&CumulativeLimit6=kr1.000%2C00&UCumulativeLimit6=1000%2C00&AuthAmount6=kr926%2C84&OpenToBuy6=kr55%2C45&UOpenToBuy6=55%2C45&MerchantId7=00000000000000000erchantName7=-&AVV7=930&CPNType7=MA&Currency7=752&Expiry7=08%2F17&IssueDate7=24%2F08%2F16&NumUsage7=0&PAN7=0000000000000000&StartDate7=08%2F16&ValidFrom7=24%2F08%2F16&ValidTo7=31%2F08%2F17&TransactionLimit7=kr100%2C00&UTransactionLimit7=100%2C00&CumulativeLimit7=kr100%2C00&UCumulativeLimit7=100%2C00&AuthAmount7=kr90%2C29&OpenToBuy7=kr9%2C71&UOpenToBuy7=9%2C71&MerchantId8=00000000000000000erchantName8=-&AVV8=662&CPNType8=MA&Currency8=752&Expiry8=08%2F18&IssueDate8=09%2F08%2F16&NumUsage8=0&PAN8=0000000000000000&StartDate8=08%2F16&ValidFrom8=09%2F08%2F16&ValidTo8=31%2F08%2F18&TransactionLimit8=kr200%2C00&UTransactionLimit8=200%2C00&CumulativeLimit8=kr200%2C00&UCumulativeLimit8=200%2C00&AuthAmount8=kr157%2C04&OpenToBuy8=kr42%2C96&UOpenToBuy8=42%2C96&MerchantId9=00000000000000000erchantName9=-&AVV9=718&CPNType9=MA&Currency9=752&Expiry9=10%2F17&IssueDate9=22%2F10%2F15&NumUsage9=0&PAN9=0000000000000000&StartDate9=10%2F15&ValidFrom9=22%2F10%2F15&ValidTo9=31%2F10%2F17&TransactionLimit9=kr500%2C00&UTransactionLimit9=500%2C00&CumulativeLimit9=kr500%2C00&UCumulativeLimit9=500%2C00&AuthAmount9=kr94%2C99&OpenToBuy9=kr402%2C87&UOpenToBuy9=402%2C87&MerchantId10=00000000000000000&MerchantName10=-&AVV10=942&CPNType10=MA&Currency10=752&Expiry10=08%2F17&IssueDate10=21%2F08%2F15&NumUsage10=0&PAN10=0000000000000000&StartDate10=08%2F15&ValidFrom10=21%2F08%2F15&ValidTo10=31%2F08%2F17&TransactionLimit10=kr1.000%2C00&UTransactionLimit10=1000%2C00&CumulativeLimit10=kr1.000%2C00&UCumulativeLimit10=1000%2C00&AuthAmount10=kr962%2C00&OpenToBuy10=kr38%2C00&UOpenToBuy10=38%2C00&Eof=true&Dummy=true"))
    }

    override fun createCard(transactionLimit: Int, cumulativeLimit: Int, validForMonths: Int): CPN {
        return CPN(ECardAPI.queryToHashMap("Action=GetCPN&AVV=624&Expiry=08%2F17&From=07%2F17&PAN=0000000000000000&ExpiryMonth=08&ExpiryYear=2017&SessionId=0000000000000000000000000000000000000000&Eof=true&Dummy=true"))
    }

    override fun getPastTransactions(start: Int): List<PastTransaction> {
        System.err.println("Faking getTransactions")
        return PastTransaction.from(ECardAPI.queryToHashMap("Action=PastTransactions&End=99&RecordCount=233&Start=0&SessionId=0000000000000000000000000000000000000000&Total=100&AuthCode1=123456&MerchantCity1=Foo1&MerchantCountry1=&MerchantName1=Bar1+CO&MicroRefNumber1=00000000000000000000000&Status1=S&TransactionDate1=12%2F07%2F17&123&CPNType1=MA&Currency1=752&ExpiryDate1=09%2F17&IssueDate1=12%2F07%2F17&NumUsage1=0&0000000000000000&ValidFrom1=12%2F07%2F17&ValidTo1=30%2F09%2F17&OriginalAmount1=kr2.967%2C81&TransactionAmount1=kr2.967%2C81&TransactionLimit1=kr3.500%2C00&UTransactionLimit1=3500%2C00&CumulativeLimit1=kr3.500%2C00&UCumulativeLimit1=3500%2C00&AuthCode2=123456&MerchantCity2=Foo2&MerchantCountry2=&MerchantName2=Bar2+CO&MicroRefNumber2=00000000000000000000000&Status2=S&TransactionDate2=28%2F06%2F17&123&CPNType2=MA&Currency2=752&ExpiryDate2=06%2F18&IssueDate2=28%2F06%2F17&NumUsage2=0&0000000000000000&ValidFrom2=28%2F06%2F17&ValidTo2=30%2F06%2F18&OriginalAmount2=kr735%2C67&TransactionAmount2=%2484%2C00&TransactionLimit2=kr1.000%2C00&UTransactionLimit2=1000%2C00&CumulativeLimit2=kr1.000%2C00&UCumulativeLimit2=1000%2C00&AuthCode3=123456&MerchantCity3=Foo3&MerchantCountry3=&MerchantName3=Bar3+CO&MicroRefNumber3=00000000000000000000000&Status3=S&TransactionDate3=23%2F06%2F17&123&CPNType3=MA&Currency3=752&ExpiryDate3=12%2F17&IssueDate3=03%2F12%2F16&NumUsage3=0&0000000000000000&ValidFrom3=03%2F12%2F16&ValidTo3=31%2F12%2F17&OriginalAmount3=kr86%2C24&TransactionAmount3=JPY1.080%2C00&TransactionLimit3=kr1.000%2C00&UTransactionLimit3=1000%2C00&CumulativeLimit3=kr1.000%2C00&UCumulativeLimit3=1000%2C00&AuthCode4=123456&MerchantCity4=Foo4&MerchantCountry4=&MerchantName4=Bar4+CO&MicroRefNumber4=00000000000000000000000&Status4=S&TransactionDate4=23%2F06%2F17&123&CPNType4=MA&Currency4=752&ExpiryDate4=12%2F17&IssueDate4=03%2F12%2F16&NumUsage4=0&0000000000000000&ValidFrom4=03%2F12%2F16&ValidTo4=31%2F12%2F17&OriginalAmount4=kr241%2C49&TransactionAmount4=JPY3.024%2C00&TransactionLimit4=kr1.000%2C00&UTransactionLimit4=1000%2C00&CumulativeLimit4=kr1.000%2C00&UCumulativeLimit4=1000%2C00&AuthCode5=123456&MerchantCity5=Foo5&MerchantCountry5=&MerchantName5=Bar5+CO&MicroRefNumber5=00000000000000000000000&Status5=S&TransactionDate5=18%2F06%2F17&123&CPNType5=MA&Currency5=752&ExpiryDate5=12%2F17&IssueDate5=03%2F12%2F16&NumUsage5=0&0000000000000000&ValidFrom5=03%2F12%2F16&ValidTo5=31%2F12%2F17&OriginalAmount5=kr103%2C40&TransactionAmount5=JPY1.296%2C00&TransactionLimit5=kr1.000%2C00&UTransactionLimit5=1000%2C00&CumulativeLimit5=kr1.000%2C00&UCumulativeLimit5=1000%2C00&AuthCode6=123456&MerchantCity6=Foo6&MerchantCountry6=&MerchantName6=Bar6+CO&MicroRefNumber6=00000000000000000000000&Status6=S&TransactionDate6=18%2F04%2F17&123&CPNType6=MA&Currency6=752&ExpiryDate6=05%2F17&IssueDate6=18%2F04%2F17&NumUsage6=0&0000000000000000&ValidFrom6=18%2F04%2F17&ValidTo6=31%2F05%2F17&OriginalAmount6=kr337%2C00&TransactionAmount6=kr337%2C00&TransactionLimit6=kr400%2C00&UTransactionLimit6=400%2C00&CumulativeLimit6=kr400%2C00&UCumulativeLimit6=400%2C00&AuthCode7=123456&MerchantCity7=Foo7&MerchantCountry7=&MerchantName7=Bar7+CO&MicroRefNumber7=00000000000000000000000&Status7=S&TransactionDate7=17%2F03%2F17&123&CPNType7=MA&Currency7=752&ExpiryDate7=04%2F17&IssueDate7=17%2F03%2F17&NumUsage7=0&0000000000000000&ValidFrom7=17%2F03%2F17&ValidTo7=30%2F04%2F17&OriginalAmount7=kr790%2C00&TransactionAmount7=kr790%2C00&TransactionLimit7=kr800%2C00&UTransactionLimit7=800%2C00&CumulativeLimit7=kr800%2C00&UCumulativeLimit7=800%2C00&AuthCode8=123456&MerchantCity8=Foo8&MerchantCountry8=&MerchantName8=Bar8+CO&MicroRefNumber8=00000000000000000000000&Status8=S&TransactionDate8=05%2F03%2F17&123&CPNType8=MA&Currency8=752&ExpiryDate8=09%2F17&IssueDate8=05%2F03%2F17&NumUsage8=0&0000000000000000&ValidFrom8=05%2F03%2F17&ValidTo8=30%2F09%2F17&OriginalAmount8=kr193%2C81&TransactionAmount8=20%2C00%E2%82%AC&TransactionLimit8=kr500%2C00&UTransactionLimit8=500%2C00&CumulativeLimit8=kr500%2C00&UCumulativeLimit8=500%2C00&AuthCode9=123456&MerchantCity9=Foo9&MerchantCountry9=&MerchantName9=Bar9+CO&MicroRefNumber9=00000000000000000000000&Status9=S&TransactionDate9=14%2F02%2F17&123&CPNType9=MA&Currency9=752&ExpiryDate9=02%2F17&IssueDate9=18%2F02%2F16&NumUsage9=0&0000000000000000&ValidFrom9=18%2F02%2F16&ValidTo9=28%2F02%2F17&OriginalAmount9=kr27%2C00&TransactionAmount9=kr27%2C00&TransactionLimit9=kr1.000%2C00&UTransactionLimit9=1000%2C00&CumulativeLimit9=kr1.000%2C00&UCumulativeLimit9=1000%2C00&AuthCode10=123456&MerchantCity10=Foo10&MerchantCountry10=&MerchantName10=Bar10+CO&MicroRefNumber10=00000000000000000000000&Status10=S&TransactionDate10=13%2F02%2F17&123&CPNType10=MA&Currency10=752&ExpiryDate10=03%2F17&IssueDate10=13%2F02%2F17&NumUsage10=0&0000000000000000&ValidFrom10=13%2F02%2F17&ValidTo10=31%2F03%2F17&OriginalAmount10=kr552%2C26&TransactionAmount10=kr552%2C26&TransactionLimit10=kr1.000%2C00&UTransactionLimit10=1000%2C00&CumulativeLimit10=kr1.000%2C00&UCumulativeLimit10=1000%2C00&AuthCode11=123456&MerchantCity11=Foo11&MerchantCountry11=&MerchantName11=Bar11+CO&MicroRefNumber11=00000000000000000000000&Status11=S&TransactionDate11=10%2F02%2F17&123&CPNType11=MA&Currency11=752&ExpiryDate11=02%2F17&IssueDate11=18%2F02%2F16&NumUsage11=0&0000000000000000&ValidFrom11=18%2F02%2F16&ValidTo11=28%2F02%2F17&OriginalAmount11=kr65%2C00&TransactionAmount11=kr65%2C00&TransactionLimit11=kr1.000%2C00&UTransactionLimit11=1000%2C00&CumulativeLimit11=kr1.000%2C00&UCumulativeLimit11=1000%2C00&AuthCode12=123456&MerchantCity12=Foo12&MerchantCountry12=&MerchantName12=Bar12+CO&MicroRefNumber12=00000000000000000000000&Status12=S&TransactionDate12=03%2F02%2F17&123&CPNType12=MA&Currency12=752&ExpiryDate12=12%2F17&IssueDate12=03%2F12%2F16&NumUsage12=0&0000000000000000&ValidFrom12=03%2F12%2F16&ValidTo12=31%2F12%2F17&OriginalAmount12=kr128%2C24&TransactionAmount12=JPY1.620%2C00&TransactionLimit12=kr1.000%2C00&UTransactionLimit12=1000%2C00&CumulativeLimit12=kr1.000%2C00&UCumulativeLimit12=1000%2C00&AuthCode13=123456&MerchantCity13=Foo13&MerchantCountry13=&MerchantName13=Bar13+CO&MicroRefNumber13=00000000000000000000000&Status13=S&TransactionDate13=23%2F01%2F17&123&CPNType13=MA&Currency13=752&ExpiryDate13=12%2F17&IssueDate13=03%2F12%2F16&NumUsage13=0&0000000000000000&ValidFrom13=03%2F12%2F16&ValidTo13=31%2F12%2F17&OriginalAmount13=kr68%2C63&TransactionAmount13=JPY864%2C00&TransactionLimit13=kr1.000%2C00&UTransactionLimit13=1000%2C00&CumulativeLimit13=kr1.000%2C00&UCumulativeLimit13=1000%2C00&AuthCode14=123456&MerchantCity14=Foo14&MerchantCountry14=&MerchantName14=Bar14+CO&MicroRefNumber14=00000000000000000000000&Status14=D&TransactionDate14=01%2F01%2F17&123&CPNType14=MA&Currency14=752&ExpiryDate14=12%2F18&IssueDate14=30%2F12%2F16&NumUsage14=0&0000000000000000&ValidFrom14=30%2F12%2F16&ValidTo14=31%2F12%2F18&OriginalAmount14=kr2%2C14&TransactionAmount14=0%2C22%E2%82%AC&TransactionLimit14=kr1.000%2C00&UTransactionLimit14=1000%2C00&CumulativeLimit14=kr1.000%2C00&UCumulativeLimit14=1000%2C00&AuthCode15=123456&MerchantCity15=Foo15&MerchantCountry15=&MerchantName15=Bar15+CO&MicroRefNumber15=00000000000000000000000&Status15=D&TransactionDate15=30%2F12%2F16&123&CPNType15=MA&Currency15=752&ExpiryDate15=12%2F18&IssueDate15=30%2F12%2F16&NumUsage15=0&0000000000000000&ValidFrom15=30%2F12%2F16&ValidTo15=31%2F12%2F18&OriginalAmount15=kr518%2C92&TransactionAmount15=53%2C39%E2%82%AC&TransactionLimit15=kr1.000%2C00&UTransactionLimit15=1000%2C00&CumulativeLimit15=kr1.000%2C00&UCumulativeLimit15=1000%2C00&AuthCode16=123456&MerchantCity16=Foo16&MerchantCountry16=&MerchantName16=Bar16+CO&MicroRefNumber16=00000000000000000000000&Status16=S&TransactionDate16=26%2F12%2F16&123&CPNType16=MA&Currency16=752&ExpiryDate16=12%2F17&IssueDate16=03%2F12%2F16&NumUsage16=0&0000000000000000&ValidFrom16=03%2F12%2F16&ValidTo16=31%2F12%2F17&OriginalAmount16=kr69%2C39&TransactionAmount16=JPY864%2C00&TransactionLimit16=kr1.000%2C00&UTransactionLimit16=1000%2C00&CumulativeLimit16=kr1.000%2C00&UCumulativeLimit16=1000%2C00&AuthCode17=123456&MerchantCity17=Foo17&MerchantCountry17=&MerchantName17=Bar17+CO&MicroRefNumber17=00000000000000000000000&Status17=S&TransactionDate17=26%2F12%2F16&123&CPNType17=MA&Currency17=752&ExpiryDate17=12%2F17&IssueDate17=03%2F12%2F16&NumUsage17=0&0000000000000000&ValidFrom17=03%2F12%2F16&ValidTo17=31%2F12%2F17&OriginalAmount17=kr86%2C74&TransactionAmount17=JPY1.080%2C00&TransactionLimit17=kr1.000%2C00&UTransactionLimit17=1000%2C00&CumulativeLimit17=kr1.000%2C00&UCumulativeLimit17=1000%2C00&AuthCode18=123456&MerchantCity18=Foo18&MerchantCountry18=&MerchantName18=Bar18+CO&MicroRefNumber18=00000000000000000000000&Status18=S&TransactionDate18=22%2F12%2F16&123&CPNType18=MA&Currency18=752&ExpiryDate18=02%2F17&IssueDate18=18%2F02%2F16&NumUsage18=0&0000000000000000&ValidFrom18=18%2F02%2F16&ValidTo18=28%2F02%2F17&OriginalAmount18=kr126%2C00&TransactionAmount18=kr126%2C00&TransactionLimit18=kr1.000%2C00&UTransactionLimit18=1000%2C00&CumulativeLimit18=kr1.000%2C00&UCumulativeLimit18=1000%2C00&AuthCode19=123456&MerchantCity19=Foo19&MerchantCountry19=&MerchantName19=Bar19+CO&MicroRefNumber19=00000000000000000000000&Status19=S&TransactionDate19=03%2F12%2F16&123&CPNType19=MA&Currency19=752&ExpiryDate19=12%2F17&IssueDate19=03%2F12%2F16&NumUsage19=0&0000000000000000&ValidFrom19=03%2F12%2F16&ValidTo19=31%2F12%2F17&OriginalAmount19=kr160%2C42&TransactionAmount19=JPY1.944%2C00&TransactionLimit19=kr1.000%2C00&UTransactionLimit19=1000%2C00&CumulativeLimit19=kr1.000%2C00&UCumulativeLimit19=1000%2C00&AuthCode20=123456&MerchantCity20=Foo20&MerchantCountry20=&MerchantName20=Bar20+CO&MicroRefNumber20=00000000000000000000000&Status20=S&TransactionDate20=29%2F11%2F16&123&CPNType20=MA&Currency20=752&ExpiryDate20=12%2F16&IssueDate20=10%2F06%2F16&NumUsage20=0&0000000000000000&ValidFrom20=10%2F06%2F16&ValidTo20=31%2F12%2F16&OriginalAmount20=kr107%2C40&TransactionAmount20=JPY1.296%2C00&TransactionLimit20=kr500%2C00&UTransactionLimit20=500%2C00&CumulativeLimit20=kr500%2C00&UCumulativeLimit20=500%2C00&AuthCode21=123456&MerchantCity21=Foo21&MerchantCountry21=&MerchantName21=Bar21+CO&MicroRefNumber21=00000000000000000000000&Status21=S&TransactionDate21=15%2F11%2F16&123&CPNType21=MA&Currency21=752&ExpiryDate21=04%2F17&IssueDate21=12%2F10%2F16&NumUsage21=0&0000000000000000&ValidFrom21=12%2F10%2F16&ValidTo21=30%2F04%2F17&OriginalAmount21=kr20%2C02&TransactionAmount21=2%2C00%E2%82%AC&TransactionLimit21=kr1.000%2C00&UTransactionLimit21=1000%2C00&CumulativeLimit21=kr1.000%2C00&UCumulativeLimit21=1000%2C00&AuthCode22=123456&MerchantCity22=Foo22&MerchantCountry22=&MerchantName22=Bar22+CO&MicroRefNumber22=00000000000000000000000&Status22=S&TransactionDate22=13%2F11%2F16&123&CPNType22=MA&Currency22=752&ExpiryDate22=04%2F17&IssueDate22=12%2F10%2F16&NumUsage22=0&0000000000000000&ValidFrom22=12%2F10%2F16&ValidTo22=30%2F04%2F17&OriginalAmount22=kr549%2C33&TransactionAmount22=54%2C93%E2%82%AC&TransactionLimit22=kr1.000%2C00&UTransactionLimit22=1000%2C00&CumulativeLimit22=kr1.000%2C00&UCumulativeLimit22=1000%2C00&AuthCode23=123456&MerchantCity23=Foo23&MerchantCountry23=&MerchantName23=Bar23+CO&MicroRefNumber23=00000000000000000000000&Status23=S&TransactionDate23=13%2F11%2F16&123&CPNType23=MA&Currency23=752&ExpiryDate23=12%2F16&IssueDate23=11%2F11%2F16&NumUsage23=0&0000000000000000&ValidFrom23=11%2F11%2F16&ValidTo23=31%2F12%2F16&OriginalAmount23=kr2.498%2C52&TransactionAmount23=248%2C75%E2%82%AC&TransactionLimit23=kr2.500%2C00&UTransactionLimit23=2500%2C00&CumulativeLimit23=kr2.500%2C00&UCumulativeLimit23=2500%2C00&AuthCode24=123456&MerchantCity24=Foo24&MerchantCountry24=&MerchantName24=Bar24+CO&MicroRefNumber24=00000000000000000000000&Status24=S&TransactionDate24=01%2F11%2F16&123&CPNType24=MA&Currency24=752&ExpiryDate24=02%2F17&IssueDate24=18%2F02%2F16&NumUsage24=0&0000000000000000&ValidFrom24=18%2F02%2F16&ValidTo24=28%2F02%2F17&OriginalAmount24=kr94%2C00&TransactionAmount24=kr94%2C00&TransactionLimit24=kr1.000%2C00&UTransactionLimit24=1000%2C00&CumulativeLimit24=kr1.000%2C00&UCumulativeLimit24=1000%2C00&AuthCode25=123456&MerchantCity25=Foo25&MerchantCountry25=&MerchantName25=Bar25+CO&MicroRefNumber25=00000000000000000000000&Status25=S&TransactionDate25=12%2F10%2F16&123&CPNType25=MA&Currency25=752&ExpiryDate25=04%2F17&IssueDate25=12%2F10%2F16&NumUsage25=0&0000000000000000&ValidFrom25=12%2F10%2F16&ValidTo25=30%2F04%2F17&OriginalAmount25=kr117%2C84&TransactionAmount25=11%2C94%E2%82%AC&TransactionLimit25=kr1.000%2C00&UTransactionLimit25=1000%2C00&CumulativeLimit25=kr1.000%2C00&UCumulativeLimit25=1000%2C00&AuthCode26=123456&MerchantCity26=Foo26&MerchantCountry26=&MerchantName26=Bar26+CO&MicroRefNumber26=00000000000000000000000&Status26=S&TransactionDate26=07%2F10%2F16&123&CPNType26=MA&Currency26=752&ExpiryDate26=02%2F17&IssueDate26=18%2F02%2F16&NumUsage26=0&0000000000000000&ValidFrom26=18%2F02%2F16&ValidTo26=28%2F02%2F17&OriginalAmount26=kr108%2C00&TransactionAmount26=kr108%2C00&TransactionLimit26=kr1.000%2C00&UTransactionLimit26=1000%2C00&CumulativeLimit26=kr1.000%2C00&UCumulativeLimit26=1000%2C00&AuthCode27=123456&MerchantCity27=Foo27&MerchantCountry27=&MerchantName27=Bar27+CO&MicroRefNumber27=00000000000000000000000&Status27=S&TransactionDate27=05%2F10%2F16&123&CPNType27=MA&Currency27=752&ExpiryDate27=08%2F17&IssueDate27=24%2F08%2F16&NumUsage27=0&0000000000000000&ValidFrom27=24%2F08%2F16&ValidTo27=31%2F08%2F17&OriginalAmount27=kr25%2C29&TransactionAmount27=kr25%2C29&TransactionLimit27=kr100%2C00&UTransactionLimit27=100%2C00&CumulativeLimit27=kr100%2C00&UCumulativeLimit27=100%2C00&AuthCode28=123456&MerchantCity28=Foo28&MerchantCountry28=&MerchantName28=Bar28+CO&MicroRefNumber28=00000000000000000000000&Status28=S&TransactionDate28=06%2F09%2F16&123&CPNType28=MA&Currency28=752&ExpiryDate28=08%2F17&IssueDate28=24%2F08%2F16&NumUsage28=0&0000000000000000&ValidFrom28=24%2F08%2F16&ValidTo28=31%2F08%2F17&OriginalAmount28=kr10%2C00&TransactionAmount28=kr10%2C00&TransactionLimit28=kr100%2C00&UTransactionLimit28=100%2C00&CumulativeLimit28=kr100%2C00&UCumulativeLimit28=100%2C00&AuthCode29=123456&MerchantCity29=Foo29&MerchantCountry29=&MerchantName29=Bar29+CO&MicroRefNumber29=00000000000000000000000&Status29=S&TransactionDate29=24%2F08%2F16&123&CPNType29=MA&Currency29=752&ExpiryDate29=08%2F17&IssueDate29=24%2F08%2F16&NumUsage29=0&0000000000000000&ValidFrom29=24%2F08%2F16&ValidTo29=31%2F08%2F17&OriginalAmount29=kr55%2C00&TransactionAmount29=kr55%2C00&TransactionLimit29=kr100%2C00&UTransactionLimit29=100%2C00&CumulativeLimit29=kr100%2C00&UCumulativeLimit29=100%2C00&AuthCode30=123456&MerchantCity30=Foo30&MerchantCountry30=&MerchantName30=Bar30+CO&MicroRefNumber30=00000000000000000000000&Status30=S&TransactionDate30=12%2F08%2F16&123&CPNType30=MA&Currency30=752&ExpiryDate30=09%2F16&IssueDate30=12%2F08%2F16&NumUsage30=0&0000000000000000&ValidFrom30=12%2F08%2F16&ValidTo30=30%2F09%2F16&OriginalAmount30=kr448%2C00&TransactionAmount30=kr448%2C00&TransactionLimit30=kr500%2C00&UTransactionLimit30=500%2C00&CumulativeLimit30=kr500%2C00&UCumulativeLimit30=500%2C00&AuthCode31=123456&MerchantCity31=Foo31&MerchantCountry31=&MerchantName31=Bar31+CO&MicroRefNumber31=00000000000000000000000&Status31=S&TransactionDate31=10%2F08%2F16&123&CPNType31=MA&Currency31=752&ExpiryDate31=09%2F16&IssueDate31=10%2F08%2F16&NumUsage31=0&0000000000000000&ValidFrom31=10%2F08%2F16&ValidTo31=30%2F09%2F16&OriginalAmount31=kr2.487%2C00&TransactionAmount31=kr2.487%2C00&TransactionLimit31=kr2.600%2C00&UTransactionLimit31=2600%2C00&CumulativeLimit31=kr2.600%2C00&UCumulativeLimit31=2600%2C00&AuthCode32=123456&MerchantCity32=Foo32&MerchantCountry32=&MerchantName32=Bar32+CO&MicroRefNumber32=00000000000000000000000&Status32=S&TransactionDate32=09%2F08%2F16&123&CPNType32=MA&Currency32=752&ExpiryDate32=08%2F18&IssueDate32=09%2F08%2F16&NumUsage32=0&0000000000000000&ValidFrom32=09%2F08%2F16&ValidTo32=31%2F08%2F18&OriginalAmount32=kr35%2C04&TransactionAmount32=kr35%2C04&TransactionLimit32=kr200%2C00&UTransactionLimit32=200%2C00&CumulativeLimit32=kr200%2C00&UCumulativeLimit32=200%2C00&AuthCode33=123456&MerchantCity33=Foo33&MerchantCountry33=&MerchantName33=Bar33+CO&MicroRefNumber33=00000000000000000000000&Status33=S&TransactionDate33=09%2F08%2F16&123&CPNType33=MA&Currency33=752&ExpiryDate33=08%2F18&IssueDate33=09%2F08%2F16&NumUsage33=0&0000000000000000&ValidFrom33=09%2F08%2F16&ValidTo33=31%2F08%2F18&OriginalAmount33=kr122%2C00&TransactionAmount33=kr122%2C00&TransactionLimit33=kr200%2C00&UTransactionLimit33=200%2C00&CumulativeLimit33=kr200%2C00&UCumulativeLimit33=200%2C00&AuthCode34=123456&MerchantCity34=Foo34&MerchantCountry34=&MerchantName34=Bar34+CO&MicroRefNumber34=00000000000000000000000&Status34=S&TransactionDate34=30%2F07%2F16&123&CPNType34=MA&Currency34=752&ExpiryDate34=02%2F17&IssueDate34=18%2F02%2F16&NumUsage34=0&0000000000000000&ValidFrom34=18%2F02%2F16&ValidTo34=28%2F02%2F17&OriginalAmount34=kr109%2C00&TransactionAmount34=kr109%2C00&TransactionLimit34=kr1.000%2C00&UTransactionLimit34=1000%2C00&CumulativeLimit34=kr1.000%2C00&UCumulativeLimit34=1000%2C00&AuthCode35=123456&MerchantCity35=Foo35&MerchantCountry35=&MerchantName35=Bar35+CO&MicroRefNumber35=00000000000000000000000&Status35=S&TransactionDate35=27%2F07%2F16&123&CPNType35=MA&Currency35=752&ExpiryDate35=08%2F16&IssueDate35=27%2F07%2F16&NumUsage35=0&0000000000000000&ValidFrom35=27%2F07%2F16&ValidTo35=31%2F08%2F16&OriginalAmount35=kr768%2C95&TransactionAmount35=kr768%2C95&TransactionLimit35=kr800%2C00&UTransactionLimit35=800%2C00&CumulativeLimit35=kr800%2C00&UCumulativeLimit35=800%2C00&AuthCode36=123456&MerchantCity36=Foo36&MerchantCountry36=&MerchantName36=Bar36+CO&MicroRefNumber36=00000000000000000000000&Status36=S&TransactionDate36=26%2F07%2F16&123&CPNType36=MA&Currency36=752&ExpiryDate36=08%2F16&IssueDate36=26%2F07%2F16&NumUsage36=0&0000000000000000&ValidFrom36=26%2F07%2F16&ValidTo36=31%2F08%2F16&OriginalAmount36=kr768%2C95&TransactionAmount36=kr768%2C95&TransactionLimit36=kr800%2C00&UTransactionLimit36=800%2C00&CumulativeLimit36=kr800%2C00&UCumulativeLimit36=800%2C00&AuthCode37=123456&MerchantCity37=Foo37&MerchantCountry37=&MerchantName37=Bar37+CO&MicroRefNumber37=00000000000000000000000&Status37=S&TransactionDate37=07%2F07%2F16&123&CPNType37=MA&Currency37=752&ExpiryDate37=08%2F16&IssueDate37=07%2F07%2F16&NumUsage37=0&0000000000000000&ValidFrom37=07%2F07%2F16&ValidTo37=31%2F08%2F16&OriginalAmount37=kr598%2C95&TransactionAmount37=kr598%2C95&TransactionLimit37=kr700%2C00&UTransactionLimit37=700%2C00&CumulativeLimit37=kr700%2C00&UCumulativeLimit37=700%2C00&AuthCode38=123456&MerchantCity38=Foo38&MerchantCountry38=&MerchantName38=Bar38+CO&MicroRefNumber38=00000000000000000000000&Status38=S&TransactionDate38=01%2F07%2F16&123&CPNType38=MA&Currency38=752&ExpiryDate38=10%2F17&IssueDate38=22%2F10%2F15&NumUsage38=0&0000000000000000&ValidFrom38=22%2F10%2F15&ValidTo38=31%2F10%2F17&OriginalAmount38=kr10%2C84&TransactionAmount38=%241%2C25&TransactionLimit38=kr500%2C00&UTransactionLimit38=500%2C00&CumulativeLimit38=kr500%2C00&UCumulativeLimit38=500%2C00&AuthCode39=123456&MerchantCity39=Foo39&MerchantCountry39=&MerchantName39=Bar39+CO&MicroRefNumber39=00000000000000000000000&Status39=S&TransactionDate39=25%2F06%2F16&123&CPNType39=MA&Currency39=752&ExpiryDate39=01%2F17&IssueDate39=03%2F01%2F16&NumUsage39=0&0000000000000000&ValidFrom39=03%2F01%2F16&ValidTo39=31%2F01%2F17&OriginalAmount39=kr9%2C58&TransactionAmount39=0%2C99%E2%82%AC&TransactionLimit39=kr1.000%2C00&UTransactionLimit39=1000%2C00&CumulativeLimit39=kr1.000%2C00&UCumulativeLimit39=1000%2C00&AuthCode40=123456&MerchantCity40=Foo40&MerchantCountry40=&MerchantName40=Bar40+CO&MicroRefNumber40=00000000000000000000000&Status40=S&TransactionDate40=13%2F06%2F16&123&CPNType40=MA&Currency40=752&ExpiryDate40=12%2F16&IssueDate40=10%2F06%2F16&NumUsage40=0&0000000000000000&ValidFrom40=10%2F06%2F16&ValidTo40=31%2F12%2F16&OriginalAmount40=kr112%2C79&TransactionAmount40=JPY1.404%2C00&TransactionLimit40=kr500%2C00&UTransactionLimit40=500%2C00&CumulativeLimit40=kr500%2C00&UCumulativeLimit40=500%2C00&AuthCode41=123456&MerchantCity41=Foo41&MerchantCountry41=&MerchantName41=Bar41+CO&MicroRefNumber41=00000000000000000000000&Status41=S&TransactionDate41=12%2F06%2F16&123&CPNType41=MA&Currency41=752&ExpiryDate41=12%2F16&IssueDate41=10%2F06%2F16&NumUsage41=0&0000000000000000&ValidFrom41=10%2F06%2F16&ValidTo41=31%2F12%2F16&OriginalAmount41=kr103%2C68&TransactionAmount41=JPY1.296%2C00&TransactionLimit41=kr500%2C00&UTransactionLimit41=500%2C00&CumulativeLimit41=kr500%2C00&UCumulativeLimit41=500%2C00&AuthCode42=123456&MerchantCity42=Foo42&MerchantCountry42=&MerchantName42=Bar42+CO&MicroRefNumber42=00000000000000000000000&Status42=S&TransactionDate42=10%2F06%2F16&123&CPNType42=MA&Currency42=752&ExpiryDate42=12%2F16&IssueDate42=10%2F06%2F16&NumUsage42=0&0000000000000000&ValidFrom42=10%2F06%2F16&ValidTo42=31%2F12%2F16&OriginalAmount42=kr110%2C58&TransactionAmount42=JPY1.404%2C00&TransactionLimit42=kr500%2C00&UTransactionLimit42=500%2C00&CumulativeLimit42=kr500%2C00&UCumulativeLimit42=500%2C00&AuthCode43=123456&MerchantCity43=Foo43&MerchantCountry43=&MerchantName43=Bar43+CO&MicroRefNumber43=00000000000000000000000&Status43=S&TransactionDate43=03%2F06%2F16&123&CPNType43=MA&Currency43=752&ExpiryDate43=07%2F16&IssueDate43=03%2F06%2F16&NumUsage43=0&0000000000000000&ValidFrom43=03%2F06%2F16&ValidTo43=31%2F07%2F16&OriginalAmount43=kr713%2C43&TransactionAmount43=%2484%2C00&TransactionLimit43=kr1.000%2C00&UTransactionLimit43=1000%2C00&CumulativeLimit43=kr1.000%2C00&UCumulativeLimit43=1000%2C00&AuthCode44=123456&MerchantCity44=Foo44&MerchantCountry44=&MerchantName44=Bar44+CO&MicroRefNumber44=00000000000000000000000&Status44=S&TransactionDate44=02%2F06%2F16&123&CPNType44=MA&Currency44=752&ExpiryDate44=02%2F17&IssueDate44=18%2F02%2F16&NumUsage44=0&0000000000000000&ValidFrom44=18%2F02%2F16&ValidTo44=28%2F02%2F17&OriginalAmount44=kr81%2C00&TransactionAmount44=kr81%2C00&TransactionLimit44=kr1.000%2C00&UTransactionLimit44=1000%2C00&CumulativeLimit44=kr1.000%2C00&UCumulativeLimit44=1000%2C00&AuthCode45=123456&MerchantCity45=Foo45&MerchantCountry45=&MerchantName45=Bar45+CO&MicroRefNumber45=00000000000000000000000&Status45=S&TransactionDate45=01%2F06%2F16&123&CPNType45=MA&Currency45=752&ExpiryDate45=02%2F17&IssueDate45=18%2F02%2F16&NumUsage45=0&0000000000000000&ValidFrom45=18%2F02%2F16&ValidTo45=28%2F02%2F17&OriginalAmount45=kr43%2C00&TransactionAmount45=kr43%2C00&TransactionLimit45=kr1.000%2C00&UTransactionLimit45=1000%2C00&CumulativeLimit45=kr1.000%2C00&UCumulativeLimit45=1000%2C00&AuthCode46=123456&MerchantCity46=Foo46&MerchantCountry46=&MerchantName46=Bar46+CO&MicroRefNumber46=00000000000000000000000&Status46=S&TransactionDate46=01%2F06%2F16&123&CPNType46=MA&Currency46=752&ExpiryDate46=10%2F17&IssueDate46=22%2F10%2F15&NumUsage46=0&0000000000000000&ValidFrom46=22%2F10%2F15&ValidTo46=31%2F10%2F17&OriginalAmount46=kr10%2C67&TransactionAmount46=%241%2C25&TransactionLimit46=kr500%2C00&UTransactionLimit46=500%2C00&CumulativeLimit46=kr500%2C00&UCumulativeLimit46=500%2C00&AuthCode47=123456&MerchantCity47=Foo47&MerchantCountry47=&MerchantName47=Bar47+CO&MicroRefNumber47=00000000000000000000000&Status47=S&TransactionDate47=01%2F05%2F16&123&CPNType47=MA&Currency47=752&ExpiryDate47=10%2F17&IssueDate47=22%2F10%2F15&NumUsage47=0&0000000000000000&ValidFrom47=22%2F10%2F15&ValidTo47=31%2F10%2F17&OriginalAmount47=kr10%2C31&TransactionAmount47=%241%2C25&TransactionLimit47=kr500%2C00&UTransactionLimit47=500%2C00&CumulativeLimit47=kr500%2C00&UCumulativeLimit47=500%2C00&AuthCode48=123456&MerchantCity48=Foo48&MerchantCountry48=&MerchantName48=Bar48+CO&MicroRefNumber48=00000000000000000000000&Status48=S&TransactionDate48=17%2F04%2F16&123&CPNType48=MA&Currency48=752&ExpiryDate48=10%2F16&IssueDate48=16%2F10%2F15&NumUsage48=0&0000000000000000&ValidFrom48=16%2F10%2F15&ValidTo48=31%2F10%2F16&OriginalAmount48=kr74%2C85&TransactionAmount48=JPY972%2C00&TransactionLimit48=kr1.000%2C00&UTransactionLimit48=1000%2C00&CumulativeLimit48=kr1.000%2C00&UCumulativeLimit48=1000%2C00&AuthCode49=123456&MerchantCity49=Foo49&MerchantCountry49=&MerchantName49=Bar49+CO&MicroRefNumber49=00000000000000000000000&Status49=S&TransactionDate49=09%2F04%2F16&123&CPNType49=MA&Currency49=752&ExpiryDate49=10%2F16&IssueDate49=16%2F10%2F15&NumUsage49=0&0000000000000000&ValidFrom49=16%2F10%2F15&ValidTo49=31%2F10%2F16&OriginalAmount49=kr208%2C19&TransactionAmount49=JPY2.700%2C00&TransactionLimit49=kr1.000%2C00&UTransactionLimit49=1000%2C00&CumulativeLimit49=kr1.000%2C00&UCumulativeLimit49=1000%2C00&AuthCode50=123456&MerchantCity50=Foo50&MerchantCountry50=&MerchantName50=Bar50+CO&MicroRefNumber50=00000000000000000000000&Status50=S&TransactionDate50=01%2F04%2F16&123&CPNType50=MA&Currency50=752&ExpiryDate50=10%2F17&IssueDate50=22%2F10%2F15&NumUsage50=0&0000000000000000&ValidFrom50=22%2F10%2F15&ValidTo50=31%2F10%2F17&OriginalAmount50=kr10%2C42&TransactionAmount50=%241%2C25&TransactionLimit50=kr500%2C00&UTransactionLimit50=500%2C00&CumulativeLimit50=kr500%2C00&UCumulativeLimit50=500%2C00&AuthCode51=123456&MerchantCity51=Foo51&MerchantCountry51=&MerchantName51=Bar51+CO&MicroRefNumber51=00000000000000000000000&Status51=S&TransactionDate51=25%2F03%2F16&123&CPNType51=MA&Currency51=752&ExpiryDate51=01%2F17&IssueDate51=03%2F01%2F16&NumUsage51=0&0000000000000000&ValidFrom51=03%2F01%2F16&ValidTo51=31%2F01%2F17&OriginalAmount51=kr160%2C11&TransactionAmount51=16%2C99%E2%82%AC&TransactionLimit51=kr1.000%2C00&UTransactionLimit51=1000%2C00&CumulativeLimit51=kr1.000%2C00&UCumulativeLimit51=1000%2C00&AuthCode52=123456&MerchantCity52=Foo52&MerchantCountry52=&MerchantName52=Bar52+CO&MicroRefNumber52=00000000000000000000000&Status52=S&TransactionDate52=12%2F03%2F16&123&CPNType52=MA&Currency52=752&ExpiryDate52=09%2F16&IssueDate52=12%2F03%2F16&NumUsage52=0&0000000000000000&ValidFrom52=12%2F03%2F16&ValidTo52=30%2F09%2F16&OriginalAmount52=kr5.000%2C00&TransactionAmount52=kr5.000%2C00&TransactionLimit52=kr33.000%2C00&UTransactionLimit52=33000%2C00&CumulativeLimit52=kr33.000%2C00&UCumulativeLimit52=33000%2C00&AuthCode53=123456&MerchantCity53=Foo53&MerchantCountry53=&MerchantName53=Bar53+CO&MicroRefNumber53=00000000000000000000000&Status53=S&TransactionDate53=01%2F03%2F16&123&CPNType53=MA&Currency53=752&ExpiryDate53=10%2F17&IssueDate53=22%2F10%2F15&NumUsage53=0&0000000000000000&ValidFrom53=22%2F10%2F15&ValidTo53=31%2F10%2F17&OriginalAmount53=kr11%2C06&TransactionAmount53=%241%2C25&TransactionLimit53=kr500%2C00&UTransactionLimit53=500%2C00&CumulativeLimit53=kr500%2C00&UCumulativeLimit53=500%2C00&AuthCode54=123456&MerchantCity54=Foo54&MerchantCountry54=&MerchantName54=Bar54+CO&MicroRefNumber54=00000000000000000000000&Status54=S&TransactionDate54=26%2F02%2F16&123&CPNType54=MA&Currency54=752&ExpiryDate54=03%2F16&IssueDate54=27%2F02%2F16&NumUsage54=0&0000000000000000&ValidFrom54=27%2F02%2F16&ValidTo54=31%2F03%2F16&OriginalAmount54=kr165%2C00&TransactionAmount54=kr165%2C00&TransactionLimit54=kr200%2C00&UTransactionLimit54=200%2C00&CumulativeLimit54=kr200%2C00&UCumulativeLimit54=200%2C00&AuthCode55=123456&MerchantCity55=Foo55&MerchantCountry55=&MerchantName55=Bar55+CO&MicroRefNumber55=00000000000000000000000&Status55=S&TransactionDate55=18%2F02%2F16&123&CPNType55=MA&Currency55=752&ExpiryDate55=02%2F17&IssueDate55=18%2F02%2F16&NumUsage55=0&0000000000000000&ValidFrom55=18%2F02%2F16&ValidTo55=28%2F02%2F17&OriginalAmount55=kr148%2C00&TransactionAmount55=kr148%2C00&TransactionLimit55=kr1.000%2C00&UTransactionLimit55=1000%2C00&CumulativeLimit55=kr1.000%2C00&UCumulativeLimit55=1000%2C00&AuthCode56=123456&MerchantCity56=Foo56&MerchantCountry56=&MerchantName56=Bar56+CO&MicroRefNumber56=00000000000000000000000&Status56=S&TransactionDate56=12%2F02%2F16&123&CPNType56=MA&Currency56=752&ExpiryDate56=01%2F17&IssueDate56=03%2F01%2F16&NumUsage56=0&0000000000000000&ValidFrom56=03%2F01%2F16&ValidTo56=31%2F01%2F17&OriginalAmount56=kr72%2C57&TransactionAmount56=7%2C48%E2%82%AC&TransactionLimit56=kr1.000%2C00&UTransactionLimit56=1000%2C00&CumulativeLimit56=kr1.000%2C00&UCumulativeLimit56=1000%2C00&AuthCode57=123456&MerchantCity57=Foo57&MerchantCountry57=&MerchantName57=Bar57+CO&MicroRefNumber57=00000000000000000000000&Status57=S&TransactionDate57=06%2F02%2F16&123&CPNType57=MA&Currency57=752&ExpiryDate57=08%2F17&IssueDate57=21%2F08%2F15&NumUsage57=0&0000000000000000&ValidFrom57=21%2F08%2F15&ValidTo57=31%2F08%2F17&OriginalAmount57=kr135%2C00&TransactionAmount57=kr135%2C00&TransactionLimit57=kr1.000%2C00&UTransactionLimit57=1000%2C00&CumulativeLimit57=kr1.000%2C00&UCumulativeLimit57=1000%2C00&AuthCode58=123456&MerchantCity58=Foo58&MerchantCountry58=&MerchantName58=Bar58+CO&MicroRefNumber58=00000000000000000000000&Status58=S&TransactionDate58=02%2F02%2F16&123&CPNType58=MA&Currency58=752&ExpiryDate58=10%2F17&IssueDate58=22%2F10%2F15&NumUsage58=0&0000000000000000&ValidFrom58=22%2F10%2F15&ValidTo58=31%2F10%2F17&OriginalAmount58=kr10%2C98&TransactionAmount58=%241%2C25&TransactionLimit58=kr500%2C00&UTransactionLimit58=500%2C00&CumulativeLimit58=kr500%2C00&UCumulativeLimit58=500%2C00&AuthCode59=123456&MerchantCity59=Foo59&MerchantCountry59=&MerchantName59=Bar59+CO&MicroRefNumber59=00000000000000000000000&Status59=S&TransactionDate59=26%2F01%2F16&123&CPNType59=MA&Currency59=752&ExpiryDate59=08%2F17&IssueDate59=21%2F08%2F15&NumUsage59=0&0000000000000000&ValidFrom59=21%2F08%2F15&ValidTo59=31%2F08%2F17&OriginalAmount59=kr85%2C00&TransactionAmount59=kr85%2C00&TransactionLimit59=kr1.000%2C00&UTransactionLimit59=1000%2C00&CumulativeLimit59=kr1.000%2C00&UCumulativeLimit59=1000%2C00&AuthCode60=123456&MerchantCity60=Foo60&MerchantCountry60=&MerchantName60=Bar60+CO&MicroRefNumber60=00000000000000000000000&Status60=S&TransactionDate60=26%2F01%2F16&123&CPNType60=MA&Currency60=752&ExpiryDate60=10%2F16&IssueDate60=16%2F10%2F15&NumUsage60=0&0000000000000000&ValidFrom60=16%2F10%2F15&ValidTo60=31%2F10%2F16&OriginalAmount60=kr95%2C77&TransactionAmount60=JPY1.296%2C00&TransactionLimit60=kr1.000%2C00&UTransactionLimit60=1000%2C00&CumulativeLimit60=kr1.000%2C00&UCumulativeLimit60=1000%2C00&AuthCode61=123456&MerchantCity61=Foo61&MerchantCountry61=&MerchantName61=Bar61+CO&MicroRefNumber61=00000000000000000000000&Status61=S&TransactionDate61=15%2F01%2F16&123&CPNType61=MA&Currency61=752&ExpiryDate61=08%2F17&IssueDate61=21%2F08%2F15&NumUsage61=0&0000000000000000&ValidFrom61=21%2F08%2F15&ValidTo61=31%2F08%2F17&OriginalAmount61=kr105%2C00&TransactionAmount61=kr105%2C00&TransactionLimit61=kr1.000%2C00&UTransactionLimit61=1000%2C00&CumulativeLimit61=kr1.000%2C00&UCumulativeLimit61=1000%2C00&AuthCode62=123456&MerchantCity62=Foo62&MerchantCountry62=&MerchantName62=Bar62+CO&MicroRefNumber62=00000000000000000000000&Status62=S&TransactionDate62=13%2F01%2F16&123&CPNType62=MA&Currency62=752&ExpiryDate62=08%2F17&IssueDate62=21%2F08%2F15&NumUsage62=0&0000000000000000&ValidFrom62=21%2F08%2F15&ValidTo62=31%2F08%2F17&OriginalAmount62=kr40%2C00&TransactionAmount62=kr40%2C00&TransactionLimit62=kr1.000%2C00&UTransactionLimit62=1000%2C00&CumulativeLimit62=kr1.000%2C00&UCumulativeLimit62=1000%2C00&AuthCode63=123456&MerchantCity63=Foo63&MerchantCountry63=&MerchantName63=Bar63+CO&MicroRefNumber63=00000000000000000000000&Status63=S&TransactionDate63=05%2F01%2F16&123&CPNType63=MA&Currency63=752&ExpiryDate63=08%2F17&IssueDate63=21%2F08%2F15&NumUsage63=0&0000000000000000&ValidFrom63=21%2F08%2F15&ValidTo63=31%2F08%2F17&OriginalAmount63=kr75%2C00&TransactionAmount63=kr75%2C00&TransactionLimit63=kr1.000%2C00&UTransactionLimit63=1000%2C00&CumulativeLimit63=kr1.000%2C00&UCumulativeLimit63=1000%2C00&AuthCode64=123456&MerchantCity64=Foo64&MerchantCountry64=&MerchantName64=Bar64+CO&MicroRefNumber64=00000000000000000000000&Status64=S&TransactionDate64=03%2F01%2F16&123&CPNType64=MA&Currency64=752&ExpiryDate64=01%2F17&IssueDate64=03%2F01%2F16&NumUsage64=0&0000000000000000&ValidFrom64=03%2F01%2F16&ValidTo64=31%2F01%2F17&OriginalAmount64=kr704%2C86&TransactionAmount64=74%2C60%E2%82%AC&TransactionLimit64=kr1.000%2C00&UTransactionLimit64=1000%2C00&CumulativeLimit64=kr1.000%2C00&UCumulativeLimit64=1000%2C00&AuthCode65=123456&MerchantCity65=Foo65&MerchantCountry65=&MerchantName65=Bar65+CO&MicroRefNumber65=00000000000000000000000&Status65=S&TransactionDate65=02%2F01%2F16&123&CPNType65=MA&Currency65=752&ExpiryDate65=10%2F17&IssueDate65=22%2F10%2F15&NumUsage65=0&0000000000000000&ValidFrom65=22%2F10%2F15&ValidTo65=31%2F10%2F17&OriginalAmount65=kr10%2C80&TransactionAmount65=%241%2C25&TransactionLimit65=kr500%2C00&UTransactionLimit65=500%2C00&CumulativeLimit65=kr500%2C00&UCumulativeLimit65=500%2C00&AuthCode66=123456&MerchantCity66=Foo66&MerchantCountry66=&MerchantName66=Bar66+CO&MicroRefNumber66=00000000000000000000000&Status66=S&TransactionDate66=22%2F12%2F15&123&CPNType66=MA&Currency66=752&ExpiryDate66=08%2F17&IssueDate66=21%2F08%2F15&NumUsage66=0&0000000000000000&ValidFrom66=21%2F08%2F15&ValidTo66=31%2F08%2F17&OriginalAmount66=kr105%2C00&TransactionAmount66=kr105%2C00&TransactionLimit66=kr1.000%2C00&UTransactionLimit66=1000%2C00&CumulativeLimit66=kr1.000%2C00&UCumulativeLimit66=1000%2C00&AuthCode67=123456&MerchantCity67=Foo67&MerchantCountry67=&MerchantName67=Bar67+CO&MicroRefNumber67=00000000000000000000000&Status67=S&TransactionDate67=17%2F12%2F15&123&CPNType67=MA&Currency67=752&ExpiryDate67=01%2F16&IssueDate67=17%2F12%2F15&NumUsage67=0&0000000000000000&ValidFrom67=17%2F12%2F15&ValidTo67=31%2F01%2F16&OriginalAmount67=kr2.210%2C00&TransactionAmount67=kr2.210%2C00&TransactionLimit67=kr2.400%2C00&UTransactionLimit67=2400%2C00&CumulativeLimit67=kr2.400%2C00&UCumulativeLimit67=2400%2C00&AuthCode68=123456&MerchantCity68=Foo68&MerchantCountry68=&MerchantName68=Bar68+CO&MicroRefNumber68=00000000000000000000000&Status68=S&TransactionDate68=09%2F12%2F15&123&CPNType68=MA&Currency68=752&ExpiryDate68=08%2F17&IssueDate68=21%2F08%2F15&NumUsage68=0&0000000000000000&ValidFrom68=21%2F08%2F15&ValidTo68=31%2F08%2F17&OriginalAmount68=kr98%2C00&TransactionAmount68=kr98%2C00&TransactionLimit68=kr1.000%2C00&UTransactionLimit68=1000%2C00&CumulativeLimit68=kr1.000%2C00&UCumulativeLimit68=1000%2C00&AuthCode69=123456&MerchantCity69=Foo69&MerchantCountry69=&MerchantName69=Bar69+CO&MicroRefNumber69=00000000000000000000000&Status69=S&TransactionDate69=02%2F12%2F15&123&CPNType69=MA&Currency69=752&ExpiryDate69=10%2F17&IssueDate69=22%2F10%2F15&NumUsage69=0&0000000000000000&ValidFrom69=22%2F10%2F15&ValidTo69=31%2F10%2F17&OriginalAmount69=kr11%2C14&TransactionAmount69=%241%2C25&TransactionLimit69=kr500%2C00&UTransactionLimit69=500%2C00&CumulativeLimit69=kr500%2C00&UCumulativeLimit69=500%2C00&AuthCode70=123456&MerchantCity70=Foo70&MerchantCountry70=&MerchantName70=Bar70+CO&MicroRefNumber70=00000000000000000000000&Status70=S&TransactionDate70=16%2F11%2F15&123&CPNType70=MA&Currency70=752&ExpiryDate70=08%2F17&IssueDate70=21%2F08%2F15&NumUsage70=0&0000000000000000&ValidFrom70=21%2F08%2F15&ValidTo70=31%2F08%2F17&OriginalAmount70=kr93%2C00&TransactionAmount70=kr93%2C00&TransactionLimit70=kr1.000%2C00&UTransactionLimit70=1000%2C00&CumulativeLimit70=kr1.000%2C00&UCumulativeLimit70=1000%2C00&AuthCode71=123456&MerchantCity71=Foo71&MerchantCountry71=&MerchantName71=Bar71+CO&MicroRefNumber71=00000000000000000000000&Status71=S&TransactionDate71=08%2F11%2F15&123&CPNType71=MA&Currency71=752&ExpiryDate71=12%2F15&IssueDate71=08%2F11%2F15&NumUsage71=0&0000000000000000&ValidFrom71=08%2F11%2F15&ValidTo71=31%2F12%2F15&OriginalAmount71=kr2.968%2C43&TransactionAmount71=311%2C25%E2%82%AC&TransactionLimit71=kr3.100%2C00&UTransactionLimit71=3100%2C00&CumulativeLimit71=kr3.100%2C00&UCumulativeLimit71=3100%2C00&AuthCode72=123456&MerchantCity72=Foo72&MerchantCountry72=&MerchantName72=Bar72+CO&MicroRefNumber72=00000000000000000000000&Status72=S&TransactionDate72=02%2F11%2F15&123&CPNType72=MA&Currency72=752&ExpiryDate72=10%2F17&IssueDate72=22%2F10%2F15&NumUsage72=0&0000000000000000&ValidFrom72=22%2F10%2F15&ValidTo72=31%2F10%2F17&OriginalAmount72=kr10%2C91&TransactionAmount72=%241%2C25&TransactionLimit72=kr500%2C00&UTransactionLimit72=500%2C00&CumulativeLimit72=kr500%2C00&UCumulativeLimit72=500%2C00&AuthCode73=123456&MerchantCity73=Foo73&MerchantCountry73=&MerchantName73=Bar73+CO&MicroRefNumber73=00000000000000000000000&Status73=S&TransactionDate73=23%2F10%2F15&123&CPNType73=MA&Currency73=752&ExpiryDate73=08%2F17&IssueDate73=21%2F08%2F15&NumUsage73=0&0000000000000000&ValidFrom73=21%2F08%2F15&ValidTo73=31%2F08%2F17&OriginalAmount73=kr113%2C00&TransactionAmount73=kr113%2C00&TransactionLimit73=kr1.000%2C00&UTransactionLimit73=1000%2C00&CumulativeLimit73=kr1.000%2C00&UCumulativeLimit73=1000%2C00&AuthCode74=123456&MerchantCity74=Foo74&MerchantCountry74=&MerchantName74=Bar74+CO&MicroRefNumber74=00000000000000000000000&Status74=S&TransactionDate74=17%2F10%2F15&123&CPNType74=MA&Currency74=752&ExpiryDate74=10%2F16&IssueDate74=16%2F10%2F15&NumUsage74=0&0000000000000000&ValidFrom74=16%2F10%2F15&ValidTo74=31%2F10%2F16&OriginalAmount74=kr145%2C21&TransactionAmount74=JPY2.052%2C00&TransactionLimit74=kr1.000%2C00&UTransactionLimit74=1000%2C00&CumulativeLimit74=kr1.000%2C00&UCumulativeLimit74=1000%2C00&AuthCode75=123456&MerchantCity75=Foo75&MerchantCountry75=&MerchantName75=Bar75+CO&MicroRefNumber75=00000000000000000000000&Status75=S&TransactionDate75=13%2F10%2F15&123&CPNType75=MA&Currency75=752&ExpiryDate75=09%2F16&IssueDate75=22%2F09%2F15&NumUsage75=0&0000000000000000&ValidFrom75=22%2F09%2F15&ValidTo75=30%2F09%2F16&OriginalAmount75=kr150%2C71&TransactionAmount75=JPY2.160%2C00&TransactionLimit75=kr1.000%2C00&UTransactionLimit75=1000%2C00&CumulativeLimit75=kr1.000%2C00&UCumulativeLimit75=1000%2C00&AuthCode76=123456&MerchantCity76=Foo76&MerchantCountry76=&MerchantName76=Bar76+CO&MicroRefNumber76=00000000000000000000000&Status76=D&TransactionDate76=13%2F10%2F15&123&CPNType76=MA&Currency76=752&ExpiryDate76=10%2F16&IssueDate76=12%2F10%2F15&NumUsage76=0&0000000000000000&ValidFrom76=12%2F10%2F15&ValidTo76=31%2F10%2F16&OriginalAmount76=kr90%2C45&TransactionAmount76=JPY1.296%2C00&TransactionLimit76=kr1.000%2C00&UTransactionLimit76=1000%2C00&CumulativeLimit76=kr1.000%2C00&UCumulativeLimit76=1000%2C00&AuthCode77=123456&MerchantCity77=Foo77&MerchantCountry77=&MerchantName77=Bar77+CO&MicroRefNumber77=00000000000000000000000&Status77=S&TransactionDate77=12%2F10%2F15&123&CPNType77=MA&Currency77=752&ExpiryDate77=09%2F16&IssueDate77=22%2F09%2F15&NumUsage77=0&0000000000000000&ValidFrom77=22%2F09%2F15&ValidTo77=30%2F09%2F16&OriginalAmount77=kr82%2C69&TransactionAmount77=JPY1.188%2C00&TransactionLimit77=kr1.000%2C00&UTransactionLimit77=1000%2C00&CumulativeLimit77=kr1.000%2C00&UCumulativeLimit77=1000%2C00&AuthCode78=123456&MerchantCity78=Foo78&MerchantCountry78=&MerchantName78=Bar78+CO&MicroRefNumber78=00000000000000000000000&Status78=S&TransactionDate78=12%2F10%2F15&123&CPNType78=MA&Currency78=752&ExpiryDate78=09%2F16&IssueDate78=22%2F09%2F15&NumUsage78=0&0000000000000000&ValidFrom78=22%2F09%2F15&ValidTo78=30%2F09%2F16&OriginalAmount78=kr112%2C75&TransactionAmount78=JPY1.620%2C00&TransactionLimit78=kr1.000%2C00&UTransactionLimit78=1000%2C00&CumulativeLimit78=kr1.000%2C00&UCumulativeLimit78=1000%2C00&AuthCode79=123456&MerchantCity79=Foo79&MerchantCountry79=&MerchantName79=Bar79+CO&MicroRefNumber79=00000000000000000000000&Status79=S&TransactionDate79=12%2F10%2F15&123&CPNType79=MA&Currency79=752&ExpiryDate79=09%2F16&IssueDate79=22%2F09%2F15&NumUsage79=0&0000000000000000&ValidFrom79=22%2F09%2F15&ValidTo79=30%2F09%2F16&OriginalAmount79=kr90%2C22&TransactionAmount79=JPY1.296%2C00&TransactionLimit79=kr1.000%2C00&UTransactionLimit79=1000%2C00&CumulativeLimit79=kr1.000%2C00&UCumulativeLimit79=1000%2C00&AuthCode80=123456&MerchantCity80=Foo80&MerchantCountry80=&MerchantName80=Bar80+CO&MicroRefNumber80=00000000000000000000000&Status80=S&TransactionDate80=02%2F10%2F15&123&CPNType80=MA&Currency80=752&ExpiryDate80=11%2F15&IssueDate80=02%2F10%2F15&NumUsage80=0&0000000000000000&ValidFrom80=02%2F10%2F15&ValidTo80=30%2F11%2F15&OriginalAmount80=kr939%2C15&TransactionAmount80=%24110%2C00&TransactionLimit80=kr1.320%2C00&UTransactionLimit80=1320%2C00&CumulativeLimit80=kr1.320%2C00&UCumulativeLimit80=1320%2C00&AuthCode81=123456&MerchantCity81=Foo81&MerchantCountry81=&MerchantName81=Bar81+CO&MicroRefNumber81=00000000000000000000000&Status81=S&TransactionDate81=25%2F09%2F15&123&CPNType81=MA&Currency81=752&ExpiryDate81=09%2F16&IssueDate81=22%2F09%2F15&NumUsage81=0&0000000000000000&ValidFrom81=22%2F09%2F15&ValidTo81=30%2F09%2F16&OriginalAmount81=kr193%2C25&TransactionAmount81=JPY2.700%2C00&TransactionLimit81=kr1.000%2C00&UTransactionLimit81=1000%2C00&CumulativeLimit81=kr1.000%2C00&UCumulativeLimit81=1000%2C00&AuthCode82=123456&MerchantCity82=Foo82&MerchantCountry82=&MerchantName82=Bar82+CO&MicroRefNumber82=00000000000000000000000&Status82=S&TransactionDate82=23%2F09%2F15&123&CPNType82=MA&Currency82=752&ExpiryDate82=09%2F16&IssueDate82=22%2F09%2F15&NumUsage82=0&0000000000000000&ValidFrom82=22%2F09%2F15&ValidTo82=30%2F09%2F16&OriginalAmount82=kr116%2C83&TransactionAmount82=JPY1.620%2C00&TransactionLimit82=kr1.000%2C00&UTransactionLimit82=1000%2C00&CumulativeLimit82=kr1.000%2C00&UCumulativeLimit82=1000%2C00&AuthCode83=123456&MerchantCity83=Foo83&MerchantCountry83=&MerchantName83=Bar83+CO&MicroRefNumber83=00000000000000000000000&Status83=S&TransactionDate83=23%2F09%2F15&123&CPNType83=MA&Currency83=752&ExpiryDate83=09%2F16&IssueDate83=22%2F09%2F15&NumUsage83=0&0000000000000000&ValidFrom83=22%2F09%2F15&ValidTo83=30%2F09%2F16&OriginalAmount83=kr140%2C17&TransactionAmount83=JPY1.944%2C00&TransactionLimit83=kr1.000%2C00&UTransactionLimit83=1000%2C00&CumulativeLimit83=kr1.000%2C00&UCumulativeLimit83=1000%2C00&AuthCode84=123456&MerchantCity84=Foo84&MerchantCountry84=&MerchantName84=Bar84+CO&MicroRefNumber84=00000000000000000000000&Status84=S&TransactionDate84=21%2F09%2F15&123&CPNType84=MA&Currency84=752&ExpiryDate84=09%2F15&IssueDate84=07%2F08%2F15&NumUsage84=0&0000000000000000&ValidFrom84=07%2F08%2F15&ValidTo84=30%2F09%2F15&OriginalAmount84=kr69%2C71&TransactionAmount84=JPY972%2C00&TransactionLimit84=kr700%2C00&UTransactionLimit84=700%2C00&CumulativeLimit84=kr700%2C00&UCumulativeLimit84=700%2C00&AuthCode85=123456&MerchantCity85=Foo85&MerchantCountry85=&MerchantName85=Bar85+CO&MicroRefNumber85=00000000000000000000000&Status85=S&TransactionDate85=20%2F09%2F15&123&CPNType85=MA&Currency85=752&ExpiryDate85=09%2F15&IssueDate85=07%2F08%2F15&NumUsage85=0&0000000000000000&ValidFrom85=07%2F08%2F15&ValidTo85=30%2F09%2F15&OriginalAmount85=kr84%2C49&TransactionAmount85=JPY1.188%2C00&TransactionLimit85=kr700%2C00&UTransactionLimit85=700%2C00&CumulativeLimit85=kr700%2C00&UCumulativeLimit85=700%2C00&AuthCode86=123456&MerchantCity86=Foo86&MerchantCountry86=&MerchantName86=Bar86+CO&MicroRefNumber86=00000000000000000000000&Status86=S&TransactionDate86=20%2F09%2F15&123&CPNType86=MA&Currency86=752&ExpiryDate86=09%2F15&IssueDate86=07%2F08%2F15&NumUsage86=0&0000000000000000&ValidFrom86=07%2F08%2F15&ValidTo86=30%2F09%2F15&OriginalAmount86=kr69%2C13&TransactionAmount86=JPY972%2C00&TransactionLimit86=kr700%2C00&UTransactionLimit86=700%2C00&CumulativeLimit86=kr700%2C00&UCumulativeLimit86=700%2C00&AuthCode87=123456&MerchantCity87=Foo87&MerchantCountry87=&MerchantName87=Bar87+CO&MicroRefNumber87=00000000000000000000000&Status87=S&TransactionDate87=21%2F08%2F15&123&CPNType87=MA&Currency87=752&ExpiryDate87=08%2F17&IssueDate87=21%2F08%2F15&NumUsage87=0&0000000000000000&ValidFrom87=21%2F08%2F15&ValidTo87=31%2F08%2F17&OriginalAmount87=kr113%2C00&TransactionAmount87=kr113%2C00&TransactionLimit87=kr1.000%2C00&UTransactionLimit87=1000%2C00&CumulativeLimit87=kr1.000%2C00&UCumulativeLimit87=1000%2C00&AuthCode88=123456&MerchantCity88=Foo88&MerchantCountry88=&MerchantName88=Bar88+CO&MicroRefNumber88=00000000000000000000000&Status88=S&TransactionDate88=12%2F08%2F15&123&CPNType88=MA&Currency88=752&ExpiryDate88=01%2F16&IssueDate88=18%2F07%2F15&NumUsage88=0&0000000000000000&ValidFrom88=18%2F07%2F15&ValidTo88=31%2F01%2F16&OriginalAmount88=kr129%2C04&TransactionAmount88=kr129%2C04&TransactionLimit88=kr200%2C00&UTransactionLimit88=200%2C00&CumulativeLimit88=kr200%2C00&UCumulativeLimit88=200%2C00&AuthCode89=123456&MerchantCity89=Foo89&MerchantCountry89=&MerchantName89=Bar89+CO&MicroRefNumber89=00000000000000000000000&Status89=S&TransactionDate89=08%2F08%2F15&123&CPNType89=MA&Currency89=752&ExpiryDate89=09%2F15&IssueDate89=07%2F08%2F15&NumUsage89=0&0000000000000000&ValidFrom89=07%2F08%2F15&ValidTo89=30%2F09%2F15&OriginalAmount89=kr415%2C79&TransactionAmount89=JPY5.724%2C00&TransactionLimit89=kr700%2C00&UTransactionLimit89=700%2C00&CumulativeLimit89=kr700%2C00&UCumulativeLimit89=700%2C00&AuthCode90=123456&MerchantCity90=Foo90&MerchantCountry90=&MerchantName90=Bar90+CO&MicroRefNumber90=00000000000000000000000&Status90=S&TransactionDate90=05%2F08%2F15&123&CPNType90=MA&Currency90=752&ExpiryDate90=09%2F15&IssueDate90=05%2F08%2F15&NumUsage90=0&0000000000000000&ValidFrom90=05%2F08%2F15&ValidTo90=30%2F09%2F15&OriginalAmount90=kr850%2C79&TransactionAmount90=kr850%2C79&TransactionLimit90=kr2.500%2C00&UTransactionLimit90=2500%2C00&CumulativeLimit90=kr2.500%2C00&UCumulativeLimit90=2500%2C00&AuthCode91=123456&MerchantCity91=Foo91&MerchantCountry91=&MerchantName91=Bar91+CO&MicroRefNumber91=00000000000000000000000&Status91=S&TransactionDate91=05%2F08%2F15&123&CPNType91=MA&Currency91=752&ExpiryDate91=09%2F15&IssueDate91=05%2F08%2F15&NumUsage91=0&0000000000000000&ValidFrom91=05%2F08%2F15&ValidTo91=30%2F09%2F15&OriginalAmount91=kr1.695%2C97&TransactionAmount91=kr1.695%2C97&TransactionLimit91=kr2.000%2C00&UTransactionLimit91=2000%2C00&CumulativeLimit91=kr2.000%2C00&UCumulativeLimit91=2000%2C00&AuthCode92=123456&MerchantCity92=Foo92&MerchantCountry92=&MerchantName92=Bar92+CO&MicroRefNumber92=00000000000000000000000&Status92=S&TransactionDate92=26%2F07%2F15&123&CPNType92=MA&Currency92=752&ExpiryDate92=08%2F15&IssueDate92=26%2F07%2F15&NumUsage92=0&0000000000000000&ValidFrom92=26%2F07%2F15&ValidTo92=31%2F08%2F15&OriginalAmount92=kr5.730%2C00&TransactionAmount92=kr5.730%2C00&TransactionLimit92=kr6.000%2C00&UTransactionLimit92=6000%2C00&CumulativeLimit92=kr6.000%2C00&UCumulativeLimit92=6000%2C00&AuthCode93=123456&MerchantCity93=Foo93&MerchantCountry93=&MerchantName93=Bar93+CO&MicroRefNumber93=00000000000000000000000&Status93=S&TransactionDate93=19%2F07%2F15&123&CPNType93=MA&Currency93=752&ExpiryDate93=01%2F16&IssueDate93=18%2F07%2F15&NumUsage93=0&0000000000000000&ValidFrom93=18%2F07%2F15&ValidTo93=31%2F01%2F16&OriginalAmount93=kr40%2C27&TransactionAmount93=kr40%2C27&TransactionLimit93=kr200%2C00&UTransactionLimit93=200%2C00&CumulativeLimit93=kr200%2C00&UCumulativeLimit93=200%2C00&AuthCode94=123456&MerchantCity94=Foo94&MerchantCountry94=&MerchantName94=Bar94+CO&MicroRefNumber94=00000000000000000000000&Status94=S&TransactionDate94=18%2F07%2F15&123&CPNType94=MA&Currency94=752&ExpiryDate94=08%2F15&IssueDate94=18%2F07%2F15&NumUsage94=0&0000000000000000&ValidFrom94=18%2F07%2F15&ValidTo94=31%2F08%2F15&OriginalAmount94=kr63%2C99&TransactionAmount94=6%2C69%E2%82%AC&TransactionLimit94=kr500%2C00&UTransactionLimit94=500%2C00&CumulativeLimit94=kr500%2C00&UCumulativeLimit94=500%2C00&AuthCode95=123456&MerchantCity95=Foo95&MerchantCountry95=&MerchantName95=Bar95+CO&MicroRefNumber95=00000000000000000000000&Status95=S&TransactionDate95=23%2F06%2F15&123&CPNType95=MA&Currency95=752&ExpiryDate95=07%2F15&IssueDate95=23%2F06%2F15&NumUsage95=0&0000000000000000&ValidFrom95=23%2F06%2F15&ValidTo95=31%2F07%2F15&OriginalAmount95=kr7.490%2C00&TransactionAmount95=kr7.490%2C00&TransactionLimit95=kr7.700%2C00&UTransactionLimit95=7700%2C00&CumulativeLimit95=kr7.700%2C00&UCumulativeLimit95=7700%2C00&AuthCode96=123456&MerchantCity96=Foo96&MerchantCountry96=&MerchantName96=Bar96+CO&MicroRefNumber96=00000000000000000000000&Status96=S&TransactionDate96=12%2F06%2F15&123&CPNType96=MA&Currency96=752&ExpiryDate96=12%2F15&IssueDate96=12%2F06%2F15&NumUsage96=0&0000000000000000&ValidFrom96=12%2F06%2F15&ValidTo96=31%2F12%2F15&OriginalAmount96=kr12%2C51&TransactionAmount96=1%2C32%E2%82%AC&TransactionLimit96=kr500%2C00&UTransactionLimit96=500%2C00&CumulativeLimit96=kr500%2C00&UCumulativeLimit96=500%2C00&AuthCode97=123456&MerchantCity97=Foo97&MerchantCountry97=&MerchantName97=Bar97+CO&MicroRefNumber97=00000000000000000000000&Status97=S&TransactionDate97=24%2F05%2F15&123&CPNType97=MA&Currency97=752&ExpiryDate97=06%2F15&IssueDate97=24%2F05%2F15&NumUsage97=0&0000000000000000&ValidFrom97=24%2F05%2F15&ValidTo97=30%2F06%2F15&OriginalAmount97=kr95%2C71&TransactionAmount97=10%2C19%E2%82%AC&TransactionLimit97=kr300%2C00&UTransactionLimit97=300%2C00&CumulativeLimit97=kr300%2C00&UCumulativeLimit97=300%2C00&AuthCode98=123456&MerchantCity98=Foo98&MerchantCountry98=&MerchantName98=Bar98+CO&MicroRefNumber98=00000000000000000000000&Status98=S&TransactionDate98=19%2F04%2F15&123&CPNType98=MA&Currency98=752&ExpiryDate98=05%2F15&IssueDate98=19%2F04%2F15&NumUsage98=0&0000000000000000&ValidFrom98=19%2F04%2F15&ValidTo98=31%2F05%2F15&OriginalAmount98=kr249%2C00&TransactionAmount98=kr249%2C00&TransactionLimit98=kr400%2C00&UTransactionLimit98=400%2C00&CumulativeLimit98=kr400%2C00&UCumulativeLimit98=400%2C00&AuthCode99=123456&MerchantCity99=Foo99&MerchantCountry99=&MerchantName99=Bar99+CO&MicroRefNumber99=00000000000000000000000&Status99=S&TransactionDate99=28%2F03%2F15&123&CPNType99=MA&Currency99=752&ExpiryDate99=04%2F15&IssueDate99=28%2F03%2F15&NumUsage99=0&0000000000000000&ValidFrom99=28%2F03%2F15&ValidTo99=30%2F04%2F15&OriginalAmount99=kr736%2C86&TransactionAmount99=%2484%2C00&TransactionLimit99=kr840%2C00&UTransactionLimit99=840%2C00&CumulativeLimit99=kr840%2C00&UCumulativeLimit99=840%2C00&AuthCode100=123456&MerchantCity100=Foo100&MerchantCountry100=&MerchantName100=Bar100+CO&MicroRefNumber100=00000000000000000000000&Status100=S&TransactionDate100=01%2F03%2F15&123&CPNType100=MA&Currency100=752&ExpiryDate100=01%2F16&IssueDate100=25%2F01%2F15&NumUsage100=0&0000000000000000&ValidFrom100=25%2F01%2F15&ValidTo100=31%2F01%2F16&OriginalAmount100=kr7%2C00&TransactionAmount100=kr7%2C00&TransactionLimit100=kr200%2C00&UTransactionLimit100=200%2C00&CumulativeLimit100=kr200%2C00&UCumulativeLimit100=200%2C00&Eof=true&Dummy=true"))
    }

    override fun serializeState(): String {
        return ""
    }

}

class ECardAPIImpl internal constructor(private val okhttpClient: OkHttpClient,
                                        private val cookieMonster: CookieMonster,
                                        private val loggingInterceptor: HttpLoggingInterceptor,
                                        val webServletUrl: HttpUrl,
                                        var realCard: RealCard?) : ECardAPI {

    private var sessionId: String? = null
    private var msgNo = 0

    @Synchronized
    internal fun executeWebServlet(map: Map<String, Any>): Map <String, String> {
        loggingInterceptor.level = debugLevel
        val thinClientBody = FormBody.Builder()

        if (sessionId != null) {
            thinClientBody.add("SessionId", sessionId)
            thinClientBody.add("Version", "FLEXWEBCARD-SWEDBANK_2_4_44_0")
            thinClientBody.add("MsgNo", "" + msgNo++)
        } else {
            thinClientBody.add("CardType", realCard!!.cardType.toString())
            thinClientBody.add("VCardId", realCard!!.vCardId.toString())
        }

        for ((key, value) in map) {
            thinClientBody.add(key, value.toString())
        }

        thinClientBody.add("Locale", "sv")
        thinClientBody.add("IssuerId", "1")

        val thinClientReq = Request.Builder().url(webServletUrl)
                .post(thinClientBody.build())
                .build()

        try {
            Thread.sleep(2000)
        } catch (e: InterruptedException) {
            e.printStackTrace()
        }
        val execute = okhttpClient.newCall(thinClientReq).execute()

        val body = execute.body() ?: throw IOException("No body!?")
        val responseBody = ECardAPI.NONSENSE_BUT_VALID_URL
                .newBuilder()
                .encodedQuery(body.string())
                .build()
        val resultMap = ECardAPI.queryToHashMap(responseBody)
        resultMap.remove("Eof")
        if ("Error" == resultMap["Action"]) {
            resultMap.remove("Action")
            throw IOException("" + resultMap.remove("ErrMsg") + " with result " + resultMap)
        }

        if (sessionId == null) {
            sessionId = resultMap["SessionId"]
        }
        return resultMap
    }

    override fun serializeState(): String {
        val localRealCard = realCard ?: throw IllegalStateException("No state to serialize")
        return Gson().toJson(SerializedState(cookieMonster.cookieJar, webServletUrl, localRealCard))
    }

    // This seems to be a select card, not only list profiles. YMMV?
    internal fun listProfile() {
        val req1 = LinkedHashMap<String, Any>()
        req1.put("Request", "ListProfileIds")
        req1.put("ProfileType", "")
        executeWebServlet(req1)
    }

    override fun getPastTransactions(start: Int): List<PastTransaction> {
        val req2 = LinkedHashMap<String, Any>()
        req2.put("Start", start)
        req2.put("Request", "GetPastTransactions")
        req2.put("Next", 100)

        return PastTransaction.Companion.from(executeWebServlet(req2))
    }

    override fun createCard(transactionLimit: Int, cumulativeLimit: Int, validForMonths: Int): CPN {
        val req1 = LinkedHashMap<String, Any>()
        req1.put("TransLimit", transactionLimit)
        req1.put("CumulativeLimit", cumulativeLimit)
        req1.put("ValidFor", validForMonths)
        return CPN(executeWebServlet(req1))
    }

    override fun getActiveECards(start: Int): List<ActiveECard> {
        val req1 = LinkedHashMap<String, Any>()
        req1.put("Request", "GetActiveAccounts")
        req1.put("Start", start)
        req1.put("Next", 100)
        return ActiveECard.Companion.from(executeWebServlet(req1))
    }

    override fun closeCard(creditCardNumber: String) {
        val req1 = LinkedHashMap<String, Any>()
        req1.put("Request", "CancelCPN")
        req1.put("CPNPAN", creditCardNumber)
        executeWebServlet(req1)
    }
}
